<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>
<video id="local_video">
    <script>

        const mediaConstraints = {
            audio: true, // We want an audio track
            video: true, // And we want a video track
        };

        async function main() {
            const conn = new RTCPeerConnection()


            const {rooms} = await fetch("/rooms").then(res => res.json());
            let room_id = rooms[0];

            const sdp_offer = await fetch(`/whep?target_id=${room_id}`).then(res => res.text())
            console.log(sdp_offer)


            await conn.setRemoteDescription({type: "offer", sdp: sdp_offer})

            conn.getReceivers()
            conn.addTransceiver('audio', { direction: 'recvonly' })
            conn.addTransceiver('video', { direction: 'recvonly' })

            const answer = await conn.createAnswer()

            console.log("the answer ", answer)
            console.log(conn)

            await conn.setLocalDescription(answer)


            const remoteVideo = document.querySelector("video")
            conn.ontrack = ({ track, streams }) => {
                track.onunmute = () => {
                    if (remoteVideo.srcObject) {
                        return;
                    }
                    remoteVideo.srcObject = streams[0];
                };
            };


        }

        main()
    </script>
</body>
</html>